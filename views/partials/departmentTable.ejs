<section>

    <div class="table-container table-responsive py-5">
        <table class="table table-bordered table-hover">
            <thead class="">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Head Agent</th>
                    <th scope="col">Dept Email</th>
                    <th scope="col">No. of Members</th>
                    <th scope="col">Created</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>

                <% if(departments){ %>

                    <% departments.forEach((element,idx)=>{ %>
                        <tr>
                            <th scope="row">
                                <%= ++idx %>
                            </th>
                            <input type="hidden" name="deptId" class="deptId" value="<%= element._id %> ">

                            <td>
                                <%= element.dept_name %>
                            </td>
                            <td>
                                <%= element.head_agent %>
                            </td>
                            <td>
                                <%= element.email %>
                            </td>
                            <td>
                                <%= element.members.length %>
                            </td>
                            <td>
                                <%= element.createdAt %>
                            </td>
                            <td class="action-icons">
                                <div class="td-cont">

                                    <i class="fa-solid fa-pen-to-square edit call-to-action" style="color: green;"></i>

                                    <i class="fa-regular fa-eye view call-to-action"
                                        style="color: hsl(137, 36%, 58%);"></i>

                                    <a href="#" data-toggle="modal" data-target="#basicModal"><i id="deleteUser"
                                            class="fa-solid fa-trash trash call-to-action" style="color: red;">

                                        </i>
                                    </a>

                                </div>

                            </td>
                        </tr>
                        <% }) %>
                            <% } %>


            </tbody>
        </table>
    </div>


    </main>

    <script>
        const modalContainer = document.getElementById("modal-container");
        const deleteBtnElem = document.getElementById("deleteSelectedUser")


        function renderData(_ticketId, _ticketTitle, _ticket_type) {

            console.log(_ticketId, _ticketTitle, _ticket_type)
            const modal = `

            <div class="modal fade" id="basicModal" data-backdrop="static" tabindex="-1" role="dialog"
            aria-labelledby="basicModal" aria-hidden="true">
        
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">Confirmation Message</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure, you want to delete this Ticket?</p>
                        <div class="dialog_content">
                            <h4>TicketId:</h4>
                            <h4 class="h4" style="color: #4a4747;">
                                ${_ticketId}
                        </h4>
                    </div>
                    <div class=" dialog_content">
                                    <h4>Type:</h4>
                                    <h4 class="h4" style="color: #4a4747;">
                                        ${_ticket_type}
                                    </h4>
                        </div>
                        <div class="dialog_content">
                            <h4 >Title:</h4>
                            <h4 class="h4" style="color: #4a4747;">
                                ${_ticketTitle}
                            </h4>
                        </div>
                    </div>
                    <div class=" modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal"> Close</button>
                        <button type="button" class="btn btn-danger" id="deleteSelectedUser"><span class="spinner"><i class="fa fa-refresh fa-spin"></i></span> Delete</button>
                    </div>
                </div>
            </div>
        </div>
            `
            return modal
        }



        function messageDialog(msg) {
            return (
                `
        <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="basicModal" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog modal-sm">
              <div class="modal-content">
                <div class="modal-header">
                  <h6 class="modal-title" id="myModalLabel">Confirmation Message</h6>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>${msg}.</p>
                </div>
                <div class="modal-footer">
                  
                  <button type="button" class="btn btn-success" id="refreshPage">OK</button>
                </div>
              </div>
            </div>
          </div>
        `
            )
        }


        let deptId = document.querySelectorAll(".deptId")
        //selects of nodes with the class name call-to-action
        let nodeList = document.querySelectorAll(".call-to-action")
        console.log(nodeList);
        nodeList.forEach((element, idx) => {
            let value = element.parentElement.parentElement;
            console.log(value)
            element.addEventListener("click", function (event) {
                //change the identifiers to id(to be unique in the app)
                console.log(element.classList[2])
                if (element.classList[2] === "view") {
                    //goes three levels up to get table row
                    let value = element.parentElement.parentElement.parentElement;
                    //gets and trim email element to eliminate white spaces 
                    let idString = value.children[1] ? value.children[1].value.trim() : value
                    //validates email
                    console.log(idString);
                    window.location.href = `/admin/view/department/${idString}`;

                    //condition checks if the clicked icon contains the text "edit"

                } else if (element.classList[2] === "edit") {
                    //fetchRequest()
                    let getElement = element.parentElement.parentElement;
                    //TODO: work on this 
                    //this gets individual user id from a hidden input
                    let getUserId = getElement.children[1].value
                    console.log(getElement)



                    //redirects user to update user component with userId
                    // window.location.href = `/admin/update/ticket/${getUserId}`
                } else if (element.classList[2] === "trash") {
                    let value = element.parentElement.parentElement.parentElement
                    let elementChildren = value.children
                    console.log(value)

                    return;
                    modalContainer.innerHTML = renderData(
                        elementChildren[1].value,
                        elementChildren[3].textContent.trim(),
                        elementChildren[2].textContent.trim(),
                        elementChildren[1].value
                    )
                    //spinner element
                    const spinnerElem = document.querySelector(".spinner")
                    spinnerElem.style.display = "none";

                    document.getElementById("deleteSelectedUser")
                        .addEventListener("click", function (event) {
                            document.getElementById("deleteSelectedUser").style.disabled = true
                            spinnerElem.style.display = "block";
                            const id = elementChildren[1].value
                            // event.preventDefault();
                            fetch(`/admin/delete/ticket/${id}`, {
                                method: "DELETE"

                            }).then(response => {

                                if (response.statusText === "OK") {
                                    document.getElementById("deleteSelectedUser").style.disabled = false
                                    spinnerElem.style.display = "none";
                                    document.getElementById("show-message").innerHTML = messageDialog("Ticket Has Been Deleted!");

                                    $('#basicModal').modal('hide')

                                    $('#confirmationModal').modal('show');
                                    document.getElementById("refreshPage").addEventListener("click", function (event) {
                                        location.reload()

                                    })
                                } else {
                                    document.getElementById("deleteSelectedUser").style.disabled = false
                                    spinnerElem.style.display = "none";

                                    document.getElementById("show-message").innerHTML = messageDialog("some thing went wrong");

                                }

                            }).catch(error => {
                                document.getElementById("deleteSelectedUser").style.disabled = false
                                spinnerElem.style.display = "none";

                                document.getElementById("show-message").innerHTML = messageDialog(error.message);
                            })
                        })


                    //console.log(renderData(userName, emailData, role))
                }
            })
        })

    </script>
</section>